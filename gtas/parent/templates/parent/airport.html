{% extends "base-with-menu.html" %}
{% load static %}

{% block title %}Airports{% endblock title %}

{% block stylesheets %}
    <style>
        .right {
            float: right;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="{% static 'bower_components/datatables.net-bs4/css/dataTables.bootstrap4.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'assets/pages/data-table/css/buttons.dataTables.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'bower_components/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css' %}">
{% endblock stylesheets %}

{% block body %}
<div class="pcoded-content">
    <div class="page-header card">
        <div class="row align-items-end">
            <div class="col-lg-8">
                <div class="page-header-title">
                    <i class="feather icon-user bg-c-blue"></i>
                    <div class="d-inline">
                        <h5>Airports</h5>
                        <span>CRUD for Airports</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="page-header-breadcrumb">
                    <ul class=" breadcrumb breadcrumb-title">
                        <li class="breadcrumb-item">
                            <a href="{% url 'home' %}"><i class="feather icon-home"></i></a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="#!">Parent</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{% url 'parent:airport_crud' %}">Airports</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="pcoded-inner-content">
        <div class="main-body">
            <div class="page-wrapper">

                <div class="page-body">
                    <div class="row">
                        <div class="col-lg-12">

                            <div class="card">
                                <div class="card-header">
                                    <h5>Airports</h5>
                                    <span>CRUD for Airports</span>
                                    <a data-target="#airport_modal" id="add_airport" class="btn btn-labeled btn-success" style="margin-top: 12px;"> <span class="btn-label"><i class="fa fa-plus-circle"></i></span>Add New Airport </a>
                                </div>
                                <div class="card-block">
                                    <div class="dt-responsive table-responsive">
                                        <table id="airport_table" class="table table-striped table-bordered nowrap">
                                            <thead>
                                            <tr>
                                                <th width="5%">Edit</th>
                                                <th width="5%">Delete</th>
                                                <th>city</th>
                                                <th>country</th>
                                                <th>iata</th>
                                                <th>icao</th>
                                                <th>latitude</th>
                                                <th>longitude</th>
                                                <th>name</th>
                                                <th>origin_id</th>
                                                <th>timezone</th>
                                                <th>utc_offset</th>
                                            </tr>
                                            </thead>
                                            <tfoot>
                                            <tr>
                                                <th width="5%">Edit</th>
                                                <th width="5%">Delete</th>
                                                <th>city</th>
                                                <th>country</th>
                                                <th>iata</th>
                                                <th>icao</th>
                                                <th>latitude</th>
                                                <th>longitude</th>
                                                <th>name</th>
                                                <th>origin_id</th>
                                                <th>timezone</th>
                                                <th>utc_offset</th>
                                            </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock body %}

{% block javascripts %}

    <script src="{% static 'bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'assets/pages/data-table/js/jszip.min.js' %}"></script>
    <script src="{% static 'assets/pages/data-table/js/pdfmake.min.js' %}"></script>
    <script src="{% static 'assets/pages/data-table/js/vfs_fonts.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js' %}"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // AIRPORT - READ
            var table = $('#airport_table').DataTable({
                responsive: true,
                rowId: "id",
                ajax: {"url": "{% url 'api:airport-list' %}", "dataSrc": ""},
                "columns": [
                    {"defaultContent": '<button type="button" id="airport_edit" class="btn btn-sm waves-effect waves-dark btn-info btn-outline-info update"><i class="icofont icofont-edit"></i></button>'},
                    {"defaultContent": '<button type="button" id="airport_delete" class="btn btn-sm waves-effect waves-dark btn-danger btn-outline-danger delete"><i class="icofont icofont-trash"></i></button>'},
                    {"data": "city"},
                    {"data": "country"},
                    {"data": "iata"},
                    {"data": "icao"},
                    {"data": "latitude"},
                    {"data": "longitude"},
                    {"data": "name"},
                    {"data": "origin_id"},
                    {"data": "timezone"},
                    {"data": "utc_offset"},
                ],
                language: {
                    searchPlaceholder: 'Search...',
                    sSearch: '',
                    lengthMenu: '_MENU_ items/page',
                }
            });

            $('#add_airport').click(function () {
                $('#airport_crud_form')[0].reset();
                $('#airport_modal_title').text("Add Dashboard");
                $('#operation').val("add");
                $('#airport_submit').html("Add");
                $('#airport_modal').modal('show');
            });

            // AIRPORT - CRUD FORM
            $("#airport_crud_form").on("submit", function (event) {
                event.preventDefault();

                var table = $('#airport_table').DataTable();
                var operation = document.getElementById("operation").value;
                var id = parseInt(document.getElementById("id").value);

                var row = {
                    "airport_title": document.getElementById("airport_title").value,
                    "airport_name": document.getElementById("airport_name").value,
                    "airport_uri": document.getElementById("airport_uri").value,
                    "airport_height": document.getElementById("airport_height").value
                };

                // AIRPORT - CREATE
                if (operation == 'add') {
                    $.ajax({
                        url: "{% url 'api:airport-list' %}",
                        data: row,
                        dataType: "json",
                        type: "POST",
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                        },
                        success: function (response, textStatus, xhr) {
                            //alert('Added New Dashboard');
                            toastr.success("Added New Dashboard", "CREATE");
                            table.ajax.reload();
                        },
                        error: function (XMLHttpRequest, textStatus, error) {
                            //alert("Dashboard Add error: " + textStatus + "; " + error);
                            toastr.danger("Dashboard Add error: " + textStatus, "ERROR");
                        }
                    });
                }
                // AIRPORT - UPDATE
                else if (operation == 'edit') {
                    row["id"] = id;

                    $.ajax({
                        url: "{% url 'api:airport-detail' 'id' %}".replace('id', id),
                        data: row,
                        dataType: "json",
                        type: "PUT",
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                        },
                        success: function (response, textStatus, xhr) {
                            //alert('Updated Dashboard');
                            toastr.info("Updated Dashboard", "UPDATE");
                            table.ajax.reload();
                        },
                        error: function (XMLHttpRequest, textStatus, error) {
                            //alert("Dashboard Update error: " + textStatus + "; " + error);
                            toastr.danger("Dashboard Update error: " + textStatus, "ERROR");
                        }
                    });
                }

                $('#airport_crud_form')[0].reset();
                $('#airport_modal').modal('hide');
            });

            // AIRPORT - UPDATE FORM
            $(document).on('click', '.update', function (event) {
                event.preventDefault();

                var table = $('#airport_table').DataTable();
                var id = parseInt($(this).closest('td').parent()[0].id);
                var airport = table.row($(this).parents('tr')).data();

                $('#airport_crud_form')[0].reset();
                $('#airport_modal_title').text("Edit Dashboard : " + airport.airport_title);
                $('#id').val(id);
                $('#operation').val("edit");
                $('#airport_submit').html("Update");

                // set the form value here
                $('#airport_title').val(airport.airport_title);
                $('#airport_name').val(airport.airport_name);
                $('#airport_uri').val(airport.airport_uri);
                $('#airport_height').val(airport.airport_height);

                $('#airport_modal').modal('show');
            });

            // AIRPORT - DELETE
            $(document).on('click', '.delete', function (event) {
                event.preventDefault();

                var table = $('#airport_table').DataTable();
                var id = parseInt($(this).closest('td').parent()[0].id);

                toastr.options.timeOut = "0";

                toastr.warning(`Do you want to delete this Dashboard ? <br /><br />
                    <p>
                        <button id="delete_toastr" type="button" class="btn btn-xs btn-danger">OK</button>
                        <button type="button" class="btn btn-xs btn-primary">CANCEL</button>
                    </p>
                    `, "DELETE",
                    {
                        closeButton: false,
                        allowHtml: true,
                        onShown: function (toast) {
                            $("#delete_toastr").click(function(){
                                $.ajax({
                                    url: "{% url 'api:airport-detail' 'id' %}".replace('id', id),
                                    data: id,
                                    dataType: "json",
                                    type: "DELETE",
                                    beforeSend: function (xhr, settings) {
                                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                                    },
                                    success: function (response, textStatus, xhr) {
                                        table.ajax.reload();
                                        //alert('Deleted Dashboard');
                                        toastr.info("Deleted Dashboard", "DELETE");
                                    },
                                    error: function (XMLHttpRequest, textStatus, error) {
                                        //alert("Dashboard Delete error: " + textStatus + "; " + error);
                                        toastr.danger("Dashboard Delete error: " + textStatus, "ERROR");
                                    }
                                });
                            });
                        }
                    }
                    );

                toastr.options.timeOut = "5000";
            });
        });
    </script>

{% endblock javascripts %}